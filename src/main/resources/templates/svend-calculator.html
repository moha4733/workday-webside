<!DOCTYPE html>
<html lang="da" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Svend Beregner | Workday</title>
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <style>
    .calc-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px; }
    .calc-grid { display: grid; grid-template-columns: repeat(2, minmax(200px, 1fr)); gap: 12px; }
    .calc-grid label { display: flex; flex-direction: column; font-weight: 600; color: #333; }
    .calc-grid input, .calc-grid select { margin-top: 6px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .result-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .result-table th, .result-table td { border: 1px solid #eee; padding: 10px; text-align: left; }
    .error { background: #f44336; color: #fff; padding: 10px; border-radius: 4px; margin-bottom: 12px; }
  </style>
</head>
<body>
<div class="dashboard-wrapper">
  <nav class="sidebar">
    <h2>Workday</h2>
    <ul>
      <li><a th:href="@{/svend/dashboard}">Oversigt</a></li>
      <li><a th:href="@{/svend/projects}">Projekter</a></li>
      <li><a th:href="@{/svend/calculator}" class="active">Beregner</a></li>
      <li><a th:href="@{/svend/orders}">Bestillinger</a></li>
      <li><a th:href="@{/svend/settings}">Indstillinger</a></li>
      <li><a th:href="@{/logout}" class="logout">Log ud</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <header>
      <h1>Automatisk Materialeberegner</h1>
      <p th:text="'Velkommen, ' + ${userName}">Velkommen</p>
    </header>

    <section class="table-section">
      <div class="calc-card">
        <div th:if="${project != null}" style="margin-bottom:10px;">
          <strong>Bestilling til projekt:</strong>
          <span th:text="${project.name}">Projekt</span>
          <span th:if="${project.address != null}" style="color:#666;"> — <span th:text="${project.address}"></span></span>
        </div>
        <form th:action="@{/svend/calculator}" method="get" id="calcForm">
          <div class="calc-grid">
            <label>Type
              <select name="type" id="calcType" onchange="updateFields()">
            <option value="floor" th:selected="${type == 'floor'}">Gulv</option>
            <option value="windows" th:selected="${type == 'windows'}">Vinduer/Lister</option>
            <option value="insulation" th:selected="${type == 'insulation'}">Gips/Isolering</option>
            <option value="battens" th:selected="${type == 'battens'}">Lægter</option>
              </select>
            </label>
            <div id="fields-floor">
              <label>Længde (m)
                <input type="number" step="0.01" name="length" placeholder="fx 5.6">
              </label>
              <label>Bredde (m)
                <input type="number" step="0.01" name="width" placeholder="fx 3.2">
              </label>
              <label>Spild (%) [10 standard]
                <input type="number" step="0.1" name="wastePercentage" placeholder="10">
              </label>
              <label>Pakke størrelse (m²)
                <input type="number" step="0.01" name="packageSize" placeholder="fx 2.2">
              </label>
            </div>
            <div id="fields-windows" style="display:none;">
              <label>Højde (m)
                <input type="number" step="0.01" name="height" placeholder="fx 1.2">
              </label>
              <label>Bredde (m)
                <input type="number" step="0.01" name="width" placeholder="fx 1.0">
              </label>
              <label>Antal vinduer
                <input type="number" step="1" name="windowCount" placeholder="fx 3">
              </label>
              <label>Spild (%) [10 standard]
                <input type="number" step="0.1" name="wastePercentage" placeholder="10">
              </label>
            </div>
            <div id="fields-insulation" style="display:none;">
              <label>Væglængde (m)
                <input type="number" step="0.01" name="wallLength" placeholder="fx 4.0">
              </label>
              <label>Væghøjde (m)
                <input type="number" step="0.01" name="wallHeight" placeholder="fx 2.4">
              </label>
            </div>
            <div id="fields-battens" style="display:none;">
              <label>Samlet areal (m²)
                <input type="number" step="0.01" name="battensArea" placeholder="fx 45">
              </label>
              <label>Lægteafstand (cm)
                <input type="number" step="0.1" name="battensSpacingCm" placeholder="30">
              </label>
            </div>
          </div>
          <div style="margin-top:12px;">
            <button type="submit" class="btn-small">Beregn</button>
          </div>
        </form>
      </div>

      <div th:if="${calcError}">
        <div class="error" th:text="${calcError}">Fejl</div>
      </div>
      <div th:if="${calc != null}">
        <div th:switch="${calc.type}">
          <table th:case="'floor'" class="result-table">
            <thead>
            <tr>
              <th>Netto m²</th>
              <th>Spild m²</th>
              <th>Brutto m²</th>
              <th>Anbefalet antal pakker</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td th:text="${calc.netArea}">0</td>
              <td th:text="${calc.wasteAmount}">0</td>
              <td th:text="${calc.grossArea}">0</td>
              <td th:text="${calc.recommendedOrderQuantity != null ? calc.recommendedOrderQuantity : '-'}">-</td>
            </tr>
            </tbody>
          </table>
          <table th:case="'windows'" class="result-table">
            <thead>
            <tr>
              <th>Løbende meter (inkl. spild)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td th:text="${calc.linearMeters}">0</td>
            </tr>
            </tbody>
          </table>
          <table th:case="'insulation'" class="result-table">
            <thead>
            <tr>
              <th>Isolering m²</th>
              <th>Antal gipsplader (1.2x2.4)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td th:text="${calc.insulationArea}">0</td>
              <td th:text="${calc.boardCount}">0</td>
            </tr>
            </tbody>
          </table>
          <table th:case="'battens'" class="result-table">
            <thead>
            <tr>
              <th>Løbende meter lægter</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td th:text="${calc.linearMeters}">0</td>
            </tr>
            </tbody>
          </table>
        </div>

        <form th:action="@{/svend/material-order}" method="post" style="margin-top: 12px;" class="calc-card">
          <input type="hidden" name="type" th:value="${calc.type}">
          <input type="hidden" name="projectId" th:value="${projectId}">
          <input type="hidden" name="orderDescription"
                 th:value="${calc.type == 'floor' ? 'Gulvmateriale bestilling: ' + calc.grossArea + ' m2' :
                            (calc.type == 'windows' ? 'Lister/vinduesindfatninger: ' + calc.linearMeters + ' m' :
                            (calc.type == 'insulation' ? 'Isolering: ' + calc.insulationArea + ' m2, Gips: ' + calc.boardCount + ' plader' :
                            'Lægter: ' + calc.linearMeters + ' m'))}">
          <div class="calc-grid" th:switch="${calc.type}">
            <div th:case="'floor'">
              <label>Gulvtype / Besked
                <input type="text" name="floorType" placeholder="fx laminat, parket, egetræ">
              </label>
            </div>
            <div th:case="'insulation'">
              <label>Type isolering
                <input type="text" name="insulationType" placeholder="fx mineraluld, papiruld">
              </label>
              <label>Type gips (valgfrit)
                <input type="text" name="gypsumType" placeholder="fx 13mm gips, vådrumsgips">
              </label>
            </div>
            <div th:case="'battens'">
              <label>Lægte dimension/type
                <input type="text" name="battensType" placeholder="fx 45x95 C24, trykimprægneret">
              </label>
            </div>
            <div th:case="'windows'">
              <label>Vinduestype/Lister
                <input type="text" name="windowTrimType" placeholder="fx fyr, MDF, profil A">
              </label>
            </div>
            <label>Adresse / Kommentar
              <input type="text" name="addressNote" placeholder="fx Hovedgade 123, København">
            </label>
          </div>
          <button type="submit" class="btn-small">Opret materialeanmodning</button>
        </form>
      </div>
    </section>
  </main>
</div>
<script>
  function updateFields() {
    var type = document.getElementById('calcType').value;
    document.getElementById('fields-floor').style.display = (type === 'floor') ? 'block' : 'none';
    document.getElementById('fields-windows').style.display = (type === 'windows') ? 'block' : 'none';
    document.getElementById('fields-insulation').style.display = (type === 'insulation') ? 'block' : 'none';
    document.getElementById('fields-battens').style.display = (type === 'battens') ? 'block' : 'none';
    // Toggle required for visible inputs
    const allInputs = document.querySelectorAll('#fields-floor input, #fields-windows input, #fields-insulation input, #fields-battens input');
    allInputs.forEach(i => i.required = false);
    const visibleInputs = document.querySelectorAll('#fields-' + type + ' input');
    visibleInputs.forEach(i => i.required = true);
  }
  updateFields();
</script>
</body>
</html>
